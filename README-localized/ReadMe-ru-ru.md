---
languages:
- javascript
page_type: sample
description: "В примере реализована надстройка Outlook, которая добавляет кнопки на ленту Outlook"
products:
- office
- office-outlook
urlFragment: outlook-ribbon-addin
---

# AttachmentsDemo Пример надстройки Outlook

Это пример реализации надстройки Outlook, добавляющей кнопки на ленту Outlook. Она позволяет пользователю сохранять все вложения в OneDrive. Пример иллюстрирует следующие концепции:
 
- Добавление [командных кнопок надстроек](https://docs.microsoft.com/outlook/add-ins/add-in-commands-for-outlook) на ленту Outlook при чтении почты, включая кнопку без пользовательского интерфейса и кнопку, открывающую панель задач
- Реализация веб-API для [получения вложений с помощью маркера обратного вызова и Outlook REST API](https://dev.office.com/docs/add-ins/outlook/use-rest-api)
- [использовании маркера доступа SSO](https://docs.microsoft.com/outlook/add-ins/authenticate-a-user-with-an-sso-token) для вызова API Microsoft Graph без запроса пользователя
- Если маркер единого входа недоступен, выполняется аутентификация в OneDrive пользователя с использованием неявного потока OAuth2 через библиотеку [office-js-helpers](https://github.com/OfficeDev/office-js-helpers).
- Использование [Microsoft Graph API](https://developer.microsoft.com/graph/docs/api-reference/v1.0/resources/onedrive) для создания файлов в OneDrive.

## Конфигурирование образца

Прежде чем запускать образец, вам нужно будет сделать несколько вещей, чтобы он работал правильно.

1. Вам нужен клиент Office 365 или учетная запись Outlook.com. Хотя почтовые приложения будут работать с локальными установками Exchange, для Microsoft Graph API требуется Office 365 или Outlook.com.
2. Вам необходимо зарегистрировать образец приложения на [портале регистрации приложений Microsoft](https://apps.dev.microsoft.com), чтобы получить идентификатор приложения для доступа к Microsoft Graph API.
    1. Перейдите на [портал регистрации приложений Microsoft](https://apps.dev.microsoft.com). Если вас не просят войти в систему, нажмите кнопку **Перейти к списку приложений** и войдите в свою учетную запись Microsoft (Outlook.com), а также учетную запись вашей работы или учебы (Office 365). Войдя в систему, нажмите кнопку **Добавить приложение**. Введите `AttachmentsDemo` для имени и нажмите **Создать приложение**.
    1. Найдите раздел **Секреты приложения** и нажмите **Создать новый пароль**. Появится диалоговое окно с сгенерированным паролем. Скопируйте это значение перед закрытием диалогового окна и сохраните его.
    1. Найдите раздел **платформ** и нажмите кнопку **добавить платформу**. Выберите **Веб**, а затем введите `https://localhost:44349/MessageRead.html` под **Перенаправить URI**.
        > **Примечание.** Номер порта в URI перенаправления (`44349`) может отличаться на вашем компьютере. Вы можете найти правильный номер порта для вашего компьютера, выбрав проект **AttachmentDemoWeb** в **обозревателе решений**, а затем посмотрев настройку **URL-адреса SSL** в разделе **Сервер разработки** в окне свойств.
        
    1. Нажмите **Добавить платформу**. Выберите **Web API**. Настройте этот раздел следующим образом:
        - В разделе **URI идентификатора приложения** измените значение по умолчанию, вставив свой хост и номер порта перед указанным там GUID. Например, если значение по умолчанию — `api://05adb30e-50fa-4ae2-9cec-eab2cd6095b0`, а ваше приложение выполняется на `localhost:44349`, значение будет `api://localhost:44349/05adb30e-50fa-4ae2-9cec-eab2cd6095b0`.
        - В разделе **предварительно авторизованных приложений**введите `d3590ed6-52b3-4102-aeff-aad2292ab01c` **идентификатору приложения**. Нажмите раскрывающийся список **Scope** и выберите единственную запись там. Это предварительно разрешает Desktop Office (в Windows) доступ к приложению.
        - В разделе **предварительно авторизованных приложений**введите `bc59ab01-8403-45c6-8796-ac3ef710b3e3` **идентификатору приложения**. Нажмите раскрывающийся список **Scope** и выберите единственную запись там. Это предварительно разрешает Outlook в Интернете доступ к приложению.
    1. Найдите раздел **Microsoft Graph Разрешения** в регистрации приложения. Рядом с полем **делегированные разрешения**нажмите кнопку **добавить**. Выберите **Files.ReadWrite**, **Mail.Read****offline\_access****openid****profile**. Нажмите **ОК**.

Нажмите **сохранить**, чтобы завершить регистрацию. Скопируйте **идентификатор приложения** и сохраните его там же, где и пароль приложения, который вы сохранили ранее. Эти значения скоро понадобятся нам.

Ниже показано, какие сведения необходимо указать при регистрации приложения.

![Регистрация завершенного приложения ](readme-images/app-registration.PNG)
![Регистрация завершенного приложения часть 2](readme-images/web-api-app-registration.PNG)

Отредактируйте файл [authconfig.js](AttachmentDemoWeb/Scripts/authconfig.js) и замените значение `ВАШ ИДЕНТИФИКАТОР ЗДЕСЬ` на идентификатор приложения, сгенерированный вами в процессе регистрации приложения.

Отредактируйте [AttachmentDemo.xml](AttachmentDemo/AttachmentDemoManifest/AttachmentDemo.xml) и замените значение `ВАШЕГО ИДЕНТИФИКАТОРА ПРИЛОЖЕНИЯ ЗДЕСЬ` идентификатором приложения, сгенерированным в процессе регистрации приложения.

> **Примечание**. Убедитесь, что номер порта в элементе `Resource` соответствует порту, используемому вашим проектом. Он также должен соответствовать порту, который вы использовали при регистрации приложения.

Отредактируйте файл [Web.config](AttachmentDemoWeb/Web.config) и замените значение `ВАШЕГО ИДЕНТИФИКАТОРА ПРИЛОЖЕНИЯ ЗДЕСЬ` на идентификатор приложения, а `ВАШ ПАРОЛЬ ПРИЛОЖЕНИЯ ЗДЕСЬ` \- паролем приложения, который вы создали в процессе регистрации приложения.

## Предоставьте согласие пользователя на приложение

На этом этапе мы предоставим согласие пользователя на разрешения, которые мы только что настроили в приложении. Это действие **только** необходимости, так как мы будем загружать надстройку для разработки и тестирования. Обычно производственная надстройка указывается в хранилище Office, и пользователям будет предложено дать согласие в процессе установки через хранилище.

Это можно сделать двумя способами. Вы можете использовать учетную запись администратора и предоставить согласие один раз для всех пользователей в организации Office 365 или использовать любую учетную запись, чтобы согласиться только для соответствующего пользователя.

### Предоставление согласия для всех пользователей от имени администратора

Если у вас есть доступ к учетной записи администратора клиента, то этим способом вы можете предоставить согласие для всех пользователей в организации. Это может быть удобно, если в организации есть несколько разработчиков, которым требуется работать с надстройкой и тестировать ее.

1. Перейдите в `https://login.microsoftonline.com/common/adminconsent?client_id={application_ID}&state=12345`, где `{application_ID}` — идентификатор приложения, указанный в регистрации приложений.
1. Войдите в систему с учетной записью администратора.1. Проверьте разрешения и нажмите кнопку **Принять**.

Браузер попробует выполнить перенаправление обратно в приложение, которое может быть не запущено. После нажатия кнопки **Принять** может возникнуть ошибка "Этот сайт недоступен". Это нормально. Ваше согласие все равно было зарегистрировано.

### Предоставление согласия для одного пользователя

Если у вас нет доступа к учетной записи администратора клиента или вы просто хотите предоставить согласие только для нескольких пользователей, воспользуйтесь этим способом, который позволяет предоставить согласие для одного пользователя.

1. Перейдите в `https://login.microsoftonline.com/common/oauth2/authorize?client_id={application_ID}&state=12345&response_type=code`, где `{application_ID}` — идентификатор приложения, указанный в регистрации приложений.
1. Выполните вход с помощью своей учетной записи.
1. Проверьте разрешения и нажмите кнопку **Принять**.

Браузер попробует выполнить перенаправление обратно в приложение, которое может быть не запущено. После нажатия кнопки **Принять** может возникнуть ошибка "Этот сайт недоступен". Это нормально. Ваше согласие все равно было зарегистрировано.

## Запуск образца

> **Примечание**. Visual Studio может отображать предупреждение или ошибку о недопустимости элемента `WebApplicationInfo`. Ошибка может не отображаться, пока вы не попытаетесь построить решение. При этом Visual Studio не обновила свои файлы схемы, чтобы добавить `WebApplicationInfo` элемент. Чтобы обойти эту проблему, вы можете использовать обновленный файл схемы в этом репозитории: [MailAppVersionOverridesV1\_1.xsd](manifest-schema-fix/MailAppVersionOverridesV1_1.xsd).
>
> 1. На компьютере для разработки найдите существующий MailAppVersionOverridesV1\_1. xsd. Эта возможность находится в каталоге установки Visual Studio в разделе `./Xml/Schemas/{lcid}`. Например, при стандартной установке VS 2017 32-бит для английской (США) версии можно использовать `C:\Program Files (x86) \Microsoft Studio\2017\Enterprise\Xml\Schemas\1033 Visual`.
> 1. Переименуйте существующий файл `MailAppVersionOverridesV1_1.old`.
> 1. Переместите версию файла из этого репозитория в папку.

Вы можете запустить образец прямо из Visual Studio. В **обозревателе решений** выберите **AttachmentDemo** проект, а затем выберите значение **Действия Запуска** (в окне Свойства **надстроек**). Вы можете выбрать любой установленный браузер для запуска Outlook в Интернете или выбрать **Office Desktop Client** для запуска Outlook. Если вы выбираете **Office Desktop Client**, обязательно настройте Outlook для подключения к пользователю Office 365 или Outlook.com, для которого вы хотите установить надстройку.

> **Примечание.** Функция маркера единого входа в настоящее время доступна только в Outlook 2016 для Windows.

Нажмите **F5**, чтобы построить и отладить проект. Вам будет предлагаться ввести учетную запись пользователя и пароль. Обязательно используйте пользователя в своем клиенте Office 365 или в учетной записи Outlook.com. Для этого пользователя будет установлена надстройка, и откроется Outlook в Интернете или Outlook. Выберите любое сообщение, и вы должны увидеть кнопки надстроек на ленте Outlook.

**Надстройки в Outlook на компьютере**

![Кнопки надстройки на ленте Outlook на рабочем столе](readme-images/buttons-outlook.PNG)

**Надстройки в Outlook в Интернете**

![Кнопки надстроек в Outlook в Интернете](readme-images/buttons-owa.PNG)

## Авторские права

(c) Корпорация Майкрософт (Microsoft Corporation). Все права защищены.
